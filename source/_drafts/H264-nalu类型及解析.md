title: H264 nalu类型及解析
author: Cyrus
tags: []
categories:
  - 音视频
date: 2019-01-27 21:54:00
---
首先，先看两组数据：
![](h264_data.png)

上面的数据，就是h264的视频数据。H264结构中，一个视频图像编码后的数据叫做一帧，一帧由一个片（slice）或多个片组成，一个片由一个或多个宏块（MB）组成。

#### 一、NAL
NAL全称Network Abstract Layer，即网络抽象层。在H.264/AVC视频编码标准中，整个系统框架被分为了两个层面：视频编码层面（VCL）和网络抽象层面（NAL）。其中，前者负责有效表示视频数据的内容，而后者则负责格式化数据并提供头信息，以保证数据适合各种信道和存储介质上的传输。NAL单元是NAL的基本语法结构，它包含一个字节的头信息和一系列来自VCL的称为原始字节序列载荷（RBSP）的字节流。

##### 1、帧格式

H264在网络传输的是NALU，NALU的结构是：NAL头+RBSP，实际传输中的数据流如图所示：
![](nalu_zc.png)

##### 2、帧解析（参照开始数据红色部分）
* 如果NALU对应的Slice为一帧的开始，则用4字节表示，即0x00 00 00 01;否则用3字节表示，0x00 00 01。
* NAL Header:forbidden_bit （F）1bit （在 H.264 规范中规定了这一位必须为 0.）  nal_reference_bit(优先级 NRI)2bit，取00~11,似乎指示这个NALU的重要性,如00的NALU解码器可以丢弃它而不影响图像的回放,0～3，取值越大，表示当前NAL越重要，需要优先受到保护。如果当前NAL是属于参考帧的片，或是序列参数集，或是图像参数集这些重要的单位时，本句法元素必需大于0。nal_unit_type(类型)5bit,标识其中，nal_unit_type为1， 2， 3， 4， 5的NAL单元称为VCL的NAL单元，其他类型的NAL单元为非VCL的NAL单元。

nal_unit_type. 这个NALU单元的类型,1～12由H.264使用，24～31由H.264以外的应用使用,简述如下:
![](nalu_type_define.png)

示例
~~~
00 00 00 01 67
 帧开始	 | nal header
 
 67 -->  0 1 1 0 0 1 1 1
 		 F|RNI| nal_unit_type
 可以看出，此帧为优先级最高的SPS数据
 
 同理
 00 00 00 01 68  拥有最高优先级的PPS数据
 00 00 00 01 06  拥有最低优先级的补充增强信息单元（SEI）
 00 00 00 01 65  拥有最高优先级IDR图像中的片 （即I帧，关键帧）
 00 00 00 01 61  拥有最高优先级非IDR图像的片（P/B帧)
~~~

#### 常见nal_unit_type 介绍

* SPS(nal_unit_type=7)和PPS(nal_unit_type=8)包含了初始化H264解码器所需要的信息参数，包括编码所用的profile,level,图像的宽和高，deblock滤波器等。

* I帧（nal_unit_type=5），帧内编码帧，I帧表示关键帧，可以理解为这一帧画面的完整保留，即拥有还原成图像所需的所有数据。
* I帧特点：
* 1、它是一个全帧压缩帧，将全帧图像信息进行JPEG压缩编码及传输；
* 2、解码时仅用I帧的数据就可以重构完整图像
* 3、I帧描述了图像背景和运动主体的详情。
* 4、I帧不需要参考其他画面生成
* 5、I帧是P帧和B帧的参考帧（其质量直接影响到同组中以后各帧的质量）
* 6、I帧不需要考虑运动矢量
* 7、I帧所占数据的信息量比较大

* P帧（nal_unit_type=1），前向预测编码帧。P帧表示的是这一帧跟之前的一个关键帧（或P帧）的差别，解码时需要用之前缓存的画面叠加上本帧定义的差别，生成最终画面。（也就是差别帧，P帧没有完整画面数据，只有与前一帧的画面差别的数据）
* P帧特点
* 1、P帧是I帧后面相隔1~2帧的编码帧;
* 2、P帧采用运动补偿的方法传送它与前面的I或P帧的差值及运动矢量(预测误差);
* 3、解码时必须将I帧中的预测值与预测误差求和后才能重构完整的P帧图像;
* 4、P帧属于前向预测的帧间编码。它只参考前面最靠近它的I帧或P帧;
* 5、P帧可以是其后面P帧的参考帧,也可以是其前后的B帧的参考帧;
* 6、由于P帧是参考帧,它可能造成解码错误的扩散;
* 7、由于是差值传送,P帧的压缩比较高。

* B帧（nal_unit_type=1），双向预测内插编码帧。B帧是双向差别帧，也就是B帧记录的是本帧与前后帧的差别，换言之，要解码B帧，不仅要取得之前的缓存画面，还要解码之后的画面，通过前后画面的与本帧数据的叠加取得最终的画面。B帧压缩率高，但是解码时CPU会比较累。
* B帧特点
* 1、B帧是由前面的I或P帧和后面的P帧来进行预测的;
* 2、B帧传送的是它与前面的I或P帧和后面的P帧之间的预测误差及运动矢量;
* 3、B帧是双向预测编码帧;
* 4、B帧压缩比最高,因为它只反映丙参考帧间运动主体的变化情况,预测比较准确;
* 5、B帧不是参考帧,不会造成解码错误的扩散。


<font color=ff0000>注:I、B、P各帧是根据压缩算法的需要，是人为定义的,它们都是实实在在的物理帧。一般来说，I帧的压缩率是7（跟JPG差不多），P帧是20，B帧可以达到50。可见使用B帧能节省大量空间，节省出来的空间可以用来保存多一些I帧，这样在相同码率下，可以提供更好的画质。</font>
