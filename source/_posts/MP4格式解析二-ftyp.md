title: MP4格式解析二   ftyp/mvhd
author: Cyrus
tags:
  - MP4
categories:
  - 音视频
date: 2019-08-13 23:26:00
---
### 一、ftyp
ftyp(File Type Box),该box有且只有1个，并且只能被包含在文件层，而不能被其他box包含。该box应该被放在文件的最开始，指示该MP4文件应用的相关信息。

![](ftyp_1.png)

下面看具体数据解析:

~~~
00 00 00 1C 66 74 79 70 6D 70 34 32 00 00 00 01 ; ....ftypmp42....
6D 70 34 31 6D 70 34 32 69 73 6F 6D             ; mp41mp42isom

===================== 解析 =====================
00 00 00 1C: box长度28，包括这4个字节本身，即后面还有24个字节的box body;
66 74 79 70: ftyp, box type	
6D 70 34 32: mp42, major brand
00 00 00 01: 1,	Minor version
6D 70 34 31 6D 70 34 32 69 73 6F 6D: Compatible brands, mp41 (0X6D703431), mp42 (0X6D703432), isom (0X69736F6D),说明本文件遵从（或称兼容）mp41,mp42,isom三种协议。

~~~
ftyp box通常放在文件的开始，通过对该box解析可以让我们的软件（播放器、demux、解析器）知道应该使用哪种协议对这该文件解析，是后续解读文件基础。


### 二、mvhd
#### 1、moov
在讲mvhd box之前，先简单地讲一下moov box。该box包含了文件媒体的metadata信息，“moov”是一个container box，具体内容信息由子box诠释。同File Type Box一样，该box有且只有一个，且只被包含在文件层。一般情况下，“moov”会紧随“ftyp”出现。

一般情况下，“moov”中会包含1个“mvhd”和两个“trak”(一个音频，一个视频)。其中“mvhd”为header box，一般作为“moov”的第一个子box出现（对于其他container box来说，header box都应作为首个子box出现）。“trak”包含了一个track的相关信息，是一个container box。

### 2、mvhd
mvhd(Movie Header Box),主要存放着视频文件的meta data，其中的time scale和 duration对文件的播放有着重要作用。“mvhd”结构如下表。
![](mvhd_1.png)
![](mvhd_2.png)

下面看具体数据解析:
~~~
00 00 00 6C 6D 76 68 64 00 00 00 00 D6 C0 15 26 ; ...lmvhd.......&
D6 C0 19 9A 00 00 AC 44 02 FE B7 74 00 01 00 00 ; .......D...t....
01 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 ; ................
00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 ; ................
00 00 00 00 00 00 00 00 00 00 00 00 40 00 00 00 ; ............@...
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ; ................
00 00 00 00 00 00 00 00 00 00 00 03             ; ............

===================== 解析 =====================
00 00 00 6C: 长度108

6D 76 68 64: mvhd的ASCII标识

00: box版本，0或1，一般为0

00 00 00: flags, 0

D6 C0 15 26: createTime(创建时间),从UTC时间的1904年1月1日0点至今的秒数,不过这里的时间并不影响播放器识别并播放影片。

D6 C0 19 9A: modification time（修改时间）

00 00 AC 44: time scale(44100),文件媒体在1秒时间内的刻度值，可以理解为1秒长度的时间单元数.即将1s平均分为1/44100份，每份1/44100s。timescale时间刻度贯穿在整个文件中，所有对于时间的描述都要以其为参照，例如解码时间DTS，展示时间PTS等最重要的时间描述。

02 FE B7 74: duration(50247540),媒体可播放时长.这个数值的单位与实际时间的对应关系就要通过上面的timescale参数。duration / timescale = 可播放时长（s）。这里算出该视频能播放50247540 / 44100 = 1139s, 即19分钟左右。

00 01 00 00: rate,推荐播放速率，高16位和低16位分别为小数点整数部分和小数部分，即[16.16] 格式，该值为1.0（0x00010000）表示正常前向播放

01 00: volume,与rate类似，[8.8] 格式，1.0（0x0100）表示最大音量

00 00 00 00 00 00 00 00 00 00: reverse,10字节保留位

00 01 00 00  00 00 00 00  00 00 00 00
00 00 00 00  00 01 00 00  00 00 00 00
00 00 00 00  00 00 00 00  40 00 00 00: matrix，36字节视频变换矩阵

00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00  :pre-defined, 24字节,其中包括：
	00 00 00 00: preview_time
	00 00 00 00: preview_duration
	00 00 00 00: poster_time
	00 00 00 00: selection_time
	00 00 00 00: selection_duration
	00 00 00 00: current_time


00 00 00 03: next track id(3), 下一个track使用的id号
~~~
